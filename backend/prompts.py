"""System prompts and JSON schemas for all LLM steps.

JSON schemas MUST match the frontend TypeScript types exactly.
"""

# ---------------------------------------------------------------------------
# Step 0a: Parse — split resume into sections + classify (lightweight)
# ---------------------------------------------------------------------------

PARSE_SYSTEM = """Ты — толковый карьерный консультант. Говоришь на «ты», даёшь прямые советы \
без снобизма и HR-жаргона. Твоя задача — разобрать резюме на блоки и дать первичную диагностику.

1. ОПРЕДЕЛИ ТИП РЕЗЮМЕ (что бросается в глаза с первого взгляда):
- "Список обязанностей" — опыт есть, но описан процессами, а не результатами
- "Каша из ролей" — опыт разнородный, непонятно кто этот человек
- "Джун после курсов" — нет реального коммерческого опыта
- "Переходящий" — опыт из другой сферы, хочет сменить роль
- "Нормальный" — есть результаты, нужна полировка

2. РАЗБЕЙ НА БЛОКИ ОПЫТА:
Для каждого блока:
- В full_text скопируй ВЕСЬ оригинальный текст блока как есть \
(от названия компании до конца описания). \
НЕ ПРОПУСКАЙ ни один блок опыта.

3. ОПРЕДЕЛИ:
- Red flags (частая смена работы, даунгрейд, пробелы) — \
объясняй конкретно: что увидит рекрутер и почему это тревожит
- Главная проблема этого резюме — одним предложением, как другу: \
"Тут проблема в том, что..."

4. ИЗВЛЕКИ НАВЫКИ кандидата — всё что упомянуто в резюме:
- hard_skills: инструменты, технологии, системы (1С, Excel, Bitrix, маркетплейсы и т.д.)
- soft_skills: компетенции, управленческие навыки
- domain_knowledge: отраслевая экспертиза (ВЭД, категорийный менеджмент и т.д.)

5. ОПРЕДЕЛИ ПОЛ кандидата по имени или глагольным формам в тексте \
("male" или "female"). Это нужно для правильного рода глаголов при переписывании.

НЕ анализируй содержание блоков — только разбей, классифицируй и извлеки навыки."""

PARSE_SCHEMA = {
    "type": "object",
    "properties": {
        "resume_type": {
            "type": "string",
            "enum": [
                "Список обязанностей",
                "Каша из ролей",
                "Джун после курсов",
                "Переходящий",
                "Нормальный",
            ],
        },
        "resume_type_description": {
            "type": "string",
            "description": "Объяснение типа в 1-2 предложения",
        },
        "main_problem": {
            "type": "string",
            "description": "Главная проблема резюме в одном предложении",
        },
        "red_flags": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "flag": {"type": "string"},
                    "detail": {"type": "string"},
                    "severity": {
                        "type": "string",
                        "enum": ["critical", "major", "minor"],
                    },
                },
                "required": ["flag", "detail", "severity"],
            },
        },
        "sections": {
            "type": "array",
            "description": (
                "Блоки опыта работы. "
                "КАЖДЫЙ блок из резюме должен быть здесь."
            ),
            "items": {
                "type": "object",
                "properties": {
                    "block_id": {
                        "type": "integer",
                        "description": (
                            "Порядковый номер блока начиная с 1"
                        ),
                    },
                    "section_title": {
                        "type": "string",
                        "description": "Название компании и роли",
                    },
                    "period": {"type": "string"},
                    "full_text": {
                        "type": "string",
                        "description": (
                            "ПОЛНЫЙ оригинальный текст этого блока "
                            "опыта из резюме, как есть. Копируй дословно."
                        ),
                    },
                },
                "required": [
                    "block_id",
                    "section_title",
                    "period",
                    "full_text",
                ],
            },
        },
        "key_skills": {
            "type": "object",
            "description": "Навыки кандидата, извлечённые из резюме",
            "properties": {
                "hard_skills": {
                    "type": "array",
                    "items": {"type": "string"},
                    "description": (
                        "Инструменты, технологии, системы"
                    ),
                },
                "soft_skills": {
                    "type": "array",
                    "items": {"type": "string"},
                    "description": "Компетенции, управленческие навыки",
                },
                "domain_knowledge": {
                    "type": "array",
                    "items": {"type": "string"},
                    "description": "Отраслевая экспертиза",
                },
            },
            "required": [
                "hard_skills",
                "soft_skills",
                "domain_knowledge",
            ],
        },
        "gender": {
            "type": "string",
            "enum": ["male", "female"],
            "description": "Пол кандидата (по имени или глагольным формам)",
        },
    },
    "required": [
        "resume_type",
        "resume_type_description",
        "main_problem",
        "red_flags",
        "sections",
        "key_skills",
        "gender",
    ],
}

# ---------------------------------------------------------------------------
# Step 0b: Annotate — per-section weaknesses/strengths (parallel)
# ---------------------------------------------------------------------------

ANNOTATE_SYSTEM = """Ты — толковый карьерный консультант. Говоришь прямо, без HR-жаргона, \
как друг который реально помогает. Проанализируй ОДИН блок опыта из резюме.

Тебе предоставлено полное резюме для контекста, но анализируй ТОЛЬКО указанный блок.

Представь: рекрутер открывает это резюме и за 30 секунд решает — звать или пролистать.

Что делать:
- Найди формулировки, которые звучат слабо или размыто — и объясни \
ПРОСТЫМ ЯЗЫКОМ, почему они не работают. Не "Отсутствие метрик снижает \
релевантность", а "Тут нет цифр. Рекрутер пролистает — добавь хотя бы \
порядок: десятки, сотни, тысячи?"
- Предложи направление для усиления (без переписывания)
- Укажи severity: critical / major / minor

Тон комментариев: конкретный, дружелюбный, actionable. Не оценивай — помогай.

original_text — дословная цитата из блока (подстрока full_text)."""

ANNOTATE_SCHEMA = {
    "type": "object",
    "properties": {
        "annotations": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "original_text": {
                        "type": "string",
                        "description": (
                            "Цитата из резюме "
                            "(должна быть подстрокой full_text)"
                        ),
                    },
                    "type": {
                        "type": "string",
                        "enum": ["critical", "major", "minor"],
                    },
                    "comment": {
                        "type": "string",
                        "description": "Что не так и почему",
                    },
                    "suggestion": {
                        "type": "string",
                        "description": "Направление для усиления",
                    },
                },
                "required": [
                    "original_text",
                    "type",
                    "comment",
                    "suggestion",
                ],
            },
        },
    },
    "required": ["annotations"],
}

# ---------------------------------------------------------------------------
# Step 0b: Scoring (parallel call 2 of 2)
# ---------------------------------------------------------------------------

SCORING_SYSTEM = """Ты — толковый карьерный консультант. Говоришь прямо, \
без HR-жаргона, конкретно и по делу.

Оцени резюме по 10 измерениям, каждое от 0 до 10.
Будь строгим, но справедливым. Типичное «нормальное» резюме получает 50-65 баллов, не выше.

Измерения:
1. Метрики и результаты — есть ли конкретные цифры и достижения
2. Релевантность для целевой роли — насколько опыт соответствует желаемой позиции
3. Конкретика опыта — детали vs общие слова
4. Структура и читаемость — легко ли за 30 сек понять кандидата
5. Навыки и инструменты — актуальны ли, достаточно ли
6. Позиционирование — понятно ли кто этот человек и в чём силён
7. ATS-совместимость — пройдёт ли автоматический фильтр
8. Визуальное впечатление — профессиональность оформления
9. Уникальность — чем выделяется среди 100 похожих резюме
10. Готовность к отправке — можно ли отправить рекрутеру прямо сейчас

Комментарии пиши живым языком: не "Релевантность навыков: 6/10", \
а "Навыки есть, но половина не попадёт в фильтр рекрутера. Давай переформулируем."

Вердикт — 2-3 предложения. Как если бы объяснял другу, что с его резюме не так \
и что с ним делать дальше."""

SCORING_SCHEMA = {
    "type": "object",
    "properties": {
        "dimensions": {
            "type": "array",
            "description": "Ровно 10 измерений, каждое оценено от 0 до 10",
            "items": {
                "type": "object",
                "properties": {
                    "name": {"type": "string"},
                    "score": {
                        "type": "integer",
                        "description": "0-10",
                    },
                    "comment": {"type": "string"},
                },
                "required": ["name", "score", "comment"],
            },
        },
        "verdict": {
            "type": "string",
            "description": "Общий вердикт 2-3 предложения",
        },
    },
    "required": ["dimensions", "verdict"],
}

# ---------------------------------------------------------------------------
# Step 1: Role Matching
# ---------------------------------------------------------------------------

ROLES_SYSTEM = """Ты — толковый карьерный консультант. На основе анализа \
определи 2-3 роли, на которые кандидат реально может претендовать.

Для каждой роли укажи:
- Название роли (как пишут в вакансиях)
- Уровень соответствия: высокое / среднее / с натяжкой
- match_score: 0-100 (высокое ≈ 75-95, среднее ≈ 45-74, с натяжкой ≈ 15-44)
- Что в опыте работает на эту роль — конкретно, из резюме
- Чего не хватает — но не пугай, а подскажи что подтянуть
- Типичные обязанности (одно предложение, не список)
- matched_skills: навыки кандидата, подходящие для роли
- missing_skills: что нужно для роли, но отсутствует
- Позиция в команде: reports_to и works_with

В рекомендации объясни простым языком, какую роль выбрать \
и почему — как если бы советовал другу за кофе.

Контекст анализа будет передан в сообщении пользователя."""

ROLES_USER_TEMPLATE = """Резюме:
{resume_text}

---

Результат анализа:
Тип резюме: {resume_type}
Главная проблема: {main_problem}
Red flags: {red_flags_summary}"""

ROLES_SCHEMA = {
    "type": "object",
    "properties": {
        "roles": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "role": {"type": "string"},
                    "match_level": {
                        "type": "string",
                        "enum": ["высокое", "среднее", "с натяжкой"],
                    },
                    "match_score": {
                        "type": "integer",
                        "description": "Числовая оценка соответствия 0-100",
                    },
                    "strengths": {
                        "type": "array",
                        "items": {"type": "string"},
                    },
                    "gaps": {
                        "type": "array",
                        "items": {"type": "string"},
                    },
                    "typical_duties": {
                        "type": "string",
                        "description": "Краткое описание типичных обязанностей (1-2 предложения)",
                    },
                    "matched_skills": {
                        "type": "array",
                        "items": {"type": "string"},
                        "description": "Навыки/инструменты кандидата, подходящие для этой роли",
                    },
                    "missing_skills": {
                        "type": "array",
                        "items": {"type": "string"},
                        "description": "Навыки/инструменты, нужные для роли, но отсутствующие у кандидата",
                    },
                    "reports_to": {
                        "type": "string",
                        "description": "Кому подчиняется",
                    },
                    "works_with": {
                        "type": "string",
                        "description": "С какими отделами/ролями взаимодействует",
                    },
                },
                "required": [
                    "role",
                    "match_level",
                    "match_score",
                    "strengths",
                    "gaps",
                    "typical_duties",
                    "matched_skills",
                    "missing_skills",
                    "reports_to",
                    "works_with",
                ],
            },
        },
        "recommendation": {
            "type": "object",
            "properties": {
                "primary_role": {"type": "string"},
                "reasoning": {"type": "string"},
            },
            "required": ["primary_role", "reasoning"],
        },
    },
    "required": ["roles", "recommendation"],
}

# ---------------------------------------------------------------------------
# Step 2: Rewrite — per-block (parallel calls)
# ---------------------------------------------------------------------------

REWRITE_BLOCK_SYSTEM = """Ты — толковый карьерный консультант. Кандидат выбрал \
целевую роль. Перепиши ОДИН блок опыта работы под эту роль.

ФОРМАТ: каждый буллет = что делал + какой результат + ключевые слова.
Не разделяй обязанности и результаты — совмещай в одном пункте.

ГЛАВНЫЕ ПРАВИЛА (НАРУШЕНИЕ = БРАК):
1. НЕ ВЫДУМЫВАЙ ЦИФРЫ. Если в оригинале нет метрики — ставь \
[уточнить: ...], а НЕ придумывай "~30%", "200 пользователей", "95% uptime". \
Любая цифра, которой нет в оригинале = [уточнить: описание].
2. НЕ ПОВЫШАЙ УРОВЕНЬ ОТВЕТСТВЕННОСТИ. "Участвовала в разработке" ≠ \
"Спроектировала и руководила". Если человек написал «участвовала» — он знает \
что делал. Можно предложить усилить через highlight/совет, но не молча подменять.
3. НЕ ЗАМЕНЯЙ ДЕЯТЕЛЬНОСТЬ. "Структурировала базу знаний" нельзя превращать \
в "Запустила data-продукты". Переупаковка = та же суть, лучше оформленная.
4. ВСЁ ДОБАВЛЕННОЕ, чего не было в оригинале — должно быть в [уточнить: ...].

Остальные правила:
- ГРАММАТИЧЕСКИЙ РОД: используй глагольные формы, соответствующие \
полу кандидата (указан в контексте). Ж: «Управляла», «Снизила». \
М: «Управлял», «Снизил». Это критически важно!
- СОКРАЩАЙ: оставь 5-8 самых сильных буллетов, не переписывай всё
- Каждый буллет: что делал + конкретный результат/метрика
- Естественно вплетай ключевые слова для ATS (рекрутерский поиск)
- Убери дублирование и «воду» — рекрутер читает за 30 секунд
- Где нет цифр — пометь [уточнить: ...] (кандидат заполнит)

Подсказки (highlights) пиши живым языком, как совет другу: \
не "Рекомендуется добавить метрики", а "Можно сильнее — добавь цифры: \
сколько человек, какой бюджет, на сколько % выросло?"

- highlights: параллельный массив к rewritten_bullets. \
highlights[i] = подсказка для rewritten_bullets[i]. \
Длина ОБЯЗАНА совпадать. \
Для буллетов без подсказки: action="keep", comment=""."""

REWRITE_BLOCK_SCHEMA = {
    "type": "object",
    "properties": {
        "block_id": {
            "type": "integer",
            "description": "block_id из анализа — должен совпадать",
        },
        "company": {"type": "string"},
        "role": {"type": "string"},
        "period": {"type": "string"},
        "original_bullets": {
            "type": "array",
            "items": {"type": "string"},
        },
        "rewritten_bullets": {
            "type": "array",
            "items": {"type": "string"},
        },
        "highlights": {
            "type": "array",
            "description": (
                "Параллельный массив к rewritten_bullets. "
                "Длина ДОЛЖНА совпадать."
            ),
            "items": {
                "type": "object",
                "properties": {
                    "action": {
                        "type": "string",
                        "enum": [
                            "add_metrics",
                            "rephrase",
                            "remove",
                            "clarify",
                            "keep",
                        ],
                    },
                    "comment": {
                        "type": "string",
                        "description": (
                            "Подсказка для буллета. "
                            "Пустая строка если action=keep."
                        ),
                    },
                },
                "required": ["action", "comment"],
            },
        },
        "technologies": {
            "type": "array",
            "items": {"type": "string"},
        },
        "responsibilities": {
            "type": "array",
            "items": {"type": "string"},
            "description": "Ключевые обязанности на этой позиции",
        },
    },
    "required": [
        "block_id",
        "company",
        "role",
        "period",
        "original_bullets",
        "rewritten_bullets",
        "highlights",
        "technologies",
        "responsibilities",
    ],
}

# ---------------------------------------------------------------------------
# Step 2c: Rewrite — meta (summary + skills + recommendations)
# ---------------------------------------------------------------------------

REWRITE_META_SYSTEM = """Ты — толковый карьерный консультант. \
На основе переписанных блоков опыта сгенерируй мета-информацию для резюме:

1. original_summary — оригинальный текст «О себе» из резюме (как есть)
2. summary — переписанный «О себе» (2-3 предложения) под целевую роль. \
Пиши живо и конкретно, без канцелярита.
3. skills:
   - key_competencies: ключевые компетенции
   - tools: инструменты
   - ats_keywords: ATS-ключевые слова для этой роли
4. recommendations — конкретные советы, что ещё улучшить (3-5 пунктов). \
Пиши как другу: не "Рекомендуется расширить раздел достижений", \
а "Добавь 2-3 главных достижения с цифрами — это первое что видит рекрутер"."""

REWRITE_META_SCHEMA = {
    "type": "object",
    "properties": {
        "summary": {
            "type": "string",
            "description": "Переписанный 'О себе' (2-3 предложения)",
        },
        "original_summary": {
            "type": "string",
            "description": "Оригинальный текст 'О себе' из резюме",
        },
        "skills": {
            "type": "object",
            "properties": {
                "key_competencies": {
                    "type": "array",
                    "items": {"type": "string"},
                },
                "tools": {
                    "type": "array",
                    "items": {"type": "string"},
                },
                "ats_keywords": {
                    "type": "array",
                    "items": {"type": "string"},
                },
            },
            "required": ["key_competencies", "tools", "ats_keywords"],
        },
        "recommendations": {
            "type": "array",
            "items": {"type": "string"},
        },
    },
    "required": [
        "summary",
        "original_summary",
        "skills",
        "recommendations",
    ],
}

# ---------------------------------------------------------------------------
# Step 3: Verification
# ---------------------------------------------------------------------------

VERIFY_SYSTEM = """Ты — рекрутер, который закрывает вакансию на указанную роль. \
Прочитай переупакованное резюме глазами человека, у которого в стопке \
ещё 50 таких же.

Ответь прямо и конкретно:
- Какие 3 сильные стороны бросаются в глаза сразу
- Позвал бы на интервью? (да / нет / с оговорками)
- Если не позвал бы — что именно мешает
- Чем это резюме стало лучше оригинала (главное улучшение)
- Какие риски остались — о чём спросишь на интервью"""

VERIFY_USER_TEMPLATE = """Целевая роль: {selected_role}

Переупакованное резюме:
{rewritten_resume_json}

Оригинальное резюме (для сравнения):
{original_resume_text}"""

VERIFY_SCHEMA = {
    "type": "object",
    "properties": {
        "top_strengths": {
            "type": "array",
            "items": {"type": "string"},
            "description": "3 сильные стороны, видные сразу",
        },
        "invite_to_interview": {
            "type": "string",
            "enum": ["да", "нет", "с оговорками"],
        },
        "blockers": {
            "type": "array",
            "items": {"type": "string"},
            "description": "Что мешает (если invite != да)",
        },
        "main_improvement": {
            "type": "string",
            "description": "Чем резюме стало лучше",
        },
        "remaining_risks": {
            "type": "array",
            "items": {"type": "string"},
        },
    },
    "required": [
        "top_strengths",
        "invite_to_interview",
        "blockers",
        "main_improvement",
        "remaining_risks",
    ],
}

# ---------------------------------------------------------------------------
# Regenerate bullet
# ---------------------------------------------------------------------------

REGENERATE_BULLET_SYSTEM = """Ты — толковый карьерный консультант. Кандидат \
редактирует переписанное резюме и просит переделать фрагмент буллета.

Тебе дан:
- Полный текст буллета
- Выделенный фрагмент, который нужно изменить (может быть весь буллет)
- Комментарий пользователя — что он хочет (факты, инструкция, пожелание)
- Целевая роль, под которую пишется резюме
- Пол кандидата

ПРАВИЛА:
1. Верни ВЕСЬ буллет целиком (не только выделенный фрагмент)
2. Измени ТОЛЬКО выделенный фрагмент (или то, на что он влияет). \
Остальной текст буллета сохрани максимально близко к оригиналу.
3. Если пользователь дал факты (цифры, детали) — впиши их \
ЕСТЕСТВЕННО в текст. Не добавляй ничего сверх того что дал пользователь.
4. Если пользователь дал инструкцию ("сделай короче", "добавь метрики") — \
выполни её, но не выдумывай цифры. Если нужны цифры — оставь [уточнить: ...].
5. Сохраняй тон и стиль остальных буллетов (профессиональный, результато-ориентированный).
6. Используй правильный грамматический род (указан в контексте)."""

REGENERATE_BULLET_SCHEMA = {
    "type": "object",
    "properties": {
        "new_bullet": {
            "type": "string",
            "description": "Полный текст нового буллета (весь, не только фрагмент)",
        },
    },
    "required": ["new_bullet"],
}

# ---------------------------------------------------------------------------
# Recheck
# ---------------------------------------------------------------------------

RECHECK_SYSTEM = """Ты — толковый карьерный консультант. Кандидат внёс правки \
в резюме после твоих советов. Посмотри что получилось.

Для каждого предыдущего замечания:
- Исправлено? Насколько хорошо? (отлично / хорошо / формально / не применимо)
- Если нет — напомни, но без занудства

Также:
- Пересчитай score (0-100)
- Заметил новые проблемы — скажи
- Дай обновлённый вердикт — коротко и по делу, как другу"""

RECHECK_USER_TEMPLATE = """Обновлённое резюме:
{updated_resume}

---

Предыдущие замечания (annotations):
{previous_annotations_json}

Предыдущие блокеры верификации:
{previous_blockers_json}

Предыдущий скор: {previous_score}"""

RECHECK_SCHEMA = {
    "type": "object",
    "properties": {
        "previous_issues_status": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "original_comment": {"type": "string"},
                    "status": {
                        "type": "string",
                        "enum": ["исправлено", "частично", "не исправлено"],
                    },
                    "quality": {
                        "type": "string",
                        "enum": ["отлично", "хорошо", "формально", "не применимо"],
                    },
                    "note": {"type": "string"},
                },
                "required": ["original_comment", "status", "quality", "note"],
            },
        },
        "new_issues": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "text": {"type": "string"},
                    "type": {
                        "type": "string",
                        "enum": ["critical", "major", "minor"],
                    },
                    "comment": {"type": "string"},
                },
                "required": ["text", "type", "comment"],
            },
        },
        "updated_score": {"type": "integer"},
        "score_delta": {
            "type": "integer",
            "description": "Изменение относительно прошлого скора",
        },
        "verdict": {"type": "string"},
    },
    "required": [
        "previous_issues_status",
        "new_issues",
        "updated_score",
        "score_delta",
        "verdict",
    ],
}
